name: "Build and Push to Attic"

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "Run the build with tmate debugging enabled"
        required: false
        default: false
      debug_detached:
        type: boolean
        description: "Run the build with tmate debugging enabled in detached mode"
        required: false
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.set-matrix.outputs.hosts }}
      packages: ${{ steps.set-matrix.outputs.packages }}
    steps:
      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31

      - name: Generate Build Matrix
        id: set-matrix
        run: |
          JSON=$(nix flake show --json --override-input nix-secrets ./nix-secrets-dummy)
          HOSTS=$(echo "$JSON" | jq -c '.nixosConfigurations | keys')
          PACKAGES=$(echo "$JSON" | jq -c '.packages."x86_64-linux" // {} | keys')

          echo "hosts=$HOSTS" >> $GITHUB_OUTPUT
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

  build-hosts:
    needs: generate-matrix
    if: ${{ needs.generate-matrix.outputs.hosts != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.generate-matrix.outputs.hosts) }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true
          build-mount-path: "/nix"

      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31

      - name: Setup Attic Cache
        uses: ryanccn/attic-action@v0.4.1
        with:
          endpoint: ${{ secrets.ATTIC_ENDPOINT }}
          cache: ${{ secrets.ATTIC_CACHE }}
          token: ${{ secrets.ATTIC_TOKEN }}

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        with:
          detached: ${{ inputs.debug_detached }}

      - name: Check Cache & Build System
        env:
          ATTIC_ENDPOINT: ${{ secrets.ATTIC_ENDPOINT }}
          ATTIC_CACHE: ${{ secrets.ATTIC_CACHE }}
          ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
          HOST: ${{ matrix.host }}
        run: |
          echo "::group::ðŸ” Calculating Output Path"
          EVAL_ATTR=".#nixosConfigurations.$HOST.config.system.build.toplevel.outPath"
          BUILD_ATTR=".#nixosConfigurations.$HOST.config.system.build.toplevel"

          OUT_PATH=$(nix eval --raw "$EVAL_ATTR" --override-input nix-secrets ./nix-secrets-dummy)
          STORE_HASH=$(echo "$OUT_PATH" | awk -F/ '{print $4}' | awk -F- '{print $1}')

          echo "Store Path: $OUT_PATH"
          echo "Hash: $STORE_HASH"
          echo "::endgroup::"

          echo "::group::ðŸ“¡ Checking Attic Cache"
          CACHE_URL="${ATTIC_ENDPOINT%/}/$ATTIC_CACHE/$STORE_HASH.narinfo"

          if curl --output /dev/null --silent --head --fail \
              -H "Authorization: Bearer $ATTIC_TOKEN" \
              "$CACHE_URL"; then

            echo "âœ… Cache HIT: Path exists."
            echo "Skipping build."

            NARINFO=$(curl -s -H "Authorization: Bearer $ATTIC_TOKEN" "$CACHE_URL")
            NAR_SIZE=$(echo "$NARINFO" | grep "^NarSize:" | awk '{print $2}')
            HUMAN_SIZE=$(numfmt --to=iec-i --suffix=B "$NAR_SIZE")

            echo "### âœ… $HOST: Cached" >> $GITHUB_STEP_SUMMARY
            echo "**Nar Size:** $HUMAN_SIZE (Toplevel only)" >> $GITHUB_STEP_SUMMARY
            echo "**Path:** \`$OUT_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            exit 0
          else
            echo "âš ï¸ Cache MISS: Path not found. Building..."
            echo "### ðŸ”¨ $HOST: Building" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          echo "::group::ðŸ”¨ Building & Pushing"
          attic watch-store "$ATTIC_CACHE" &
          WATCH_PID=$!

          nix build -L "$BUILD_ATTR" --override-input nix-secrets ./nix-secrets-dummy

          kill $WATCH_PID || true
          wait $WATCH_PID || true

          attic push "$ATTIC_CACHE" "$OUT_PATH"
          echo "::endgroup::"

          echo "::group::ðŸ“Š Generating Analysis"
          SIZE_BYTES=$(nix path-info -S "$OUT_PATH" | awk '{print $2}')
          TOTAL_SIZE=$(numfmt --to=iec-i --suffix=B "$SIZE_BYTES")

          echo "### ðŸ“Š Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "**Total System Size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "**Store Path:** \`$OUT_PATH\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“¦ Top 10 Largest Packages</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Size | Package |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          nix path-info -rs "$OUT_PATH" | sort -nk2 | tail -n 10 | tac | while read path size; do
            HUMAN_SIZE=$(numfmt --to=iec-i --suffix=B "$size")
            NAME=$(basename "$path" | cut -d- -f2-)
            echo "| $HUMAN_SIZE | $NAME |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "::endgroup::"

  build-packages:
    needs: generate-matrix
    if: ${{ needs.generate-matrix.outputs.packages != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.generate-matrix.outputs.packages) }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true
          build-mount-path: "/nix"

      - uses: actions/checkout@v6
      - uses: cachix/install-nix-action@v31

      - name: Setup Attic Cache
        uses: ryanccn/attic-action@v0.4.1
        with:
          endpoint: ${{ secrets.ATTIC_ENDPOINT }}
          cache: ${{ secrets.ATTIC_CACHE }}
          token: ${{ secrets.ATTIC_TOKEN }}

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        with:
          detached: ${{ inputs.debug_detached }}

      - name: Check Cache & Build Package
        env:
          ATTIC_ENDPOINT: ${{ secrets.ATTIC_ENDPOINT }}
          ATTIC_CACHE: ${{ secrets.ATTIC_CACHE }}
          ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
          PKG: ${{ matrix.package }}
        run: |
          echo "::group::ðŸ” Calculating Output Path"
          EVAL_ATTR=".#packages.x86_64-linux.$PKG.outPath"
          BUILD_ATTR=".#packages.x86_64-linux.$PKG"

          OUT_PATH=$(nix eval --raw "$EVAL_ATTR" --override-input nix-secrets ./nix-secrets-dummy)
          STORE_HASH=$(echo "$OUT_PATH" | awk -F/ '{print $4}' | awk -F- '{print $1}')

          echo "Store Path: $OUT_PATH"
          echo "Hash: $STORE_HASH"
          echo "::endgroup::"

          echo "::group::ðŸ“¡ Checking Attic Cache"
          CACHE_URL="${ATTIC_ENDPOINT%/}/$ATTIC_CACHE/$STORE_HASH.narinfo"

          if curl --output /dev/null --silent --head --fail \
              -H "Authorization: Bearer $ATTIC_TOKEN" \
              "$CACHE_URL"; then

            echo "âœ… Cache HIT: Path exists."
            echo "Skipping build."

            NARINFO=$(curl -s -H "Authorization: Bearer $ATTIC_TOKEN" "$CACHE_URL")
            NAR_SIZE=$(echo "$NARINFO" | grep "^NarSize:" | awk '{print $2}')
            HUMAN_SIZE=$(numfmt --to=iec-i --suffix=B "$NAR_SIZE")

            echo "### âœ… $PKG: Cached" >> $GITHUB_STEP_SUMMARY
            echo "**Nar Size:** $HUMAN_SIZE (Toplevel only)" >> $GITHUB_STEP_SUMMARY
            echo "**Path:** \`$OUT_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "::endgroup::"
            exit 0
          else
            echo "âš ï¸ Cache MISS: Path not found."
            echo "### ðŸ”¨ $PKG: Building" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          echo "::group::ðŸ”¨ Building & Pushing"
          attic watch-store "$ATTIC_CACHE" &
          WATCH_PID=$!

          nix build -L "$BUILD_ATTR" --override-input nix-secrets ./nix-secrets-dummy

          kill $WATCH_PID || true
          wait $WATCH_PID || true

          attic push "$ATTIC_CACHE" "$OUT_PATH"
          echo "::endgroup::"

          echo "::group::ðŸ“Š Generating Analysis"
          SIZE_BYTES=$(nix path-info -S "$OUT_PATH" | awk '{print $2}')
          TOTAL_SIZE=$(numfmt --to=iec-i --suffix=B "$SIZE_BYTES")

          echo "### ðŸ“Š Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "**Closure Size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "**Store Path:** \`$OUT_PATH\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“¦ Top 10 Largest Dependencies</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Size | Package |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          nix path-info -rs "$OUT_PATH" | sort -nk2 | tail -n 10 | tac | while read path size; do
            HUMAN_SIZE=$(numfmt --to=iec-i --suffix=B "$size")
            NAME=$(basename "$path" | cut -d- -f2-)
            echo "| $HUMAN_SIZE | $NAME |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "::endgroup::"
